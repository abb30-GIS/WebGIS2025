<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers Map Switcher : Gemini</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Set the map container height and ensure it uses the full flex space */
        #map {
            width: 100%;
            height: 70vh; /* Responsive height */
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
    <!-- OpenLayers CSS and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
</head>
<body class="bg-gray-50 font-sans p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">OpenLayers Layer Control</h1>

        <!-- Map and Controls Container -->
        <div class="flex flex-col md:flex-row gap-6">

            <!-- Controls Panel -->
            <div class="bg-white p-6 rounded-xl shadow-lg w-full md:w-1/3 h-fit">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Map Layers</h2>

                <!-- Basemap Switcher -->
                <div class="mb-6">
                    <p class="font-medium text-gray-600 mb-2">Basemap Selector:</p>
                    <div id="basemap-switcher" class="flex flex-col space-y-2">
                        <!-- Radio buttons populated by JS for cleaner control logic -->
                        <label class="flex items-center text-sm text-gray-600 cursor-pointer hover:text-gray-900">
                            <input type="radio" name="basemap" value="OSM" checked class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500 mr-2">
                            OpenStreetMap
                        </label>
                        <label class="flex items-center text-sm text-gray-600 cursor-pointer hover:text-gray-900">
                            <input type="radio" name="basemap" value="ESRI Imagery" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500 mr-2">
                            ESRI World Imagery
                        </label>
                    </div>
                </div>

                <!-- WMS Layer Toggle -->
                <div>
                    <p class="font-medium text-gray-600 mb-2">Overlay Layers:</p>
                    <label class="flex items-center text-sm text-gray-600 cursor-pointer hover:text-gray-900">
                        <input type="checkbox" id="wms-toggle" checked class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500 mr-2">
                        WMS: U.S. States (topp:states)
                    </label>
                </div>
            </div>

            <!-- Map Container -->
            <div id="map" class="w-full md:w-2/3">
                <!-- Map will be rendered here -->
            </div>

        </div>
    </div>

    <!-- OpenLayers JS Script must be loaded after the CSS and the map div -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>

    <script>
        // Use an IIFE for scope and to ensure the DOM is ready
        window.onload = function() {
            // Load the Firebase config and initialize the app ID
            // NOTE: Firestore is not used in this app, but these variables are required in the Canvas environment
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

            // 1. Define the Layers
            // Base Layers (only one can be visible at a time)
            const osmLayer = new ol.layer.Tile({
                source: new ol.source.OSM(),
                title: 'OSM',
                type: 'base',
                visible: true // Default basemap
            });

            // ESRI World Imagery XYZ Tile Source
            const esriImageryLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    attributions: '&copy; <a href="http://www.esri.com/">Esri</a>, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community'
                }),
                title: 'ESRI Imagery',
                type: 'base',
                visible: false
            });

            // WMS Layer (topp:states)
            const wmsLayer = new ol.layer.Image({
                source: new ol.source.ImageWMS({
                    url: 'https://ahocevar.com/geoserver/wms',
                    params: {
                        'LAYERS': 'topp:states',
                        'TILED': true,
                        // Requesting an image format that supports transparency
                        'FORMAT': 'image/png' 
                    },
                    serverType: 'geoserver' // Helps OpenLayers optimize requests
                }),
                title: 'States WMS',
                visible: true // Default visible
            });

            // Group the basemaps so we can easily control which one is visible
            const baseLayerGroup = new ol.layer.Group({
                layers: [osmLayer, esriImageryLayer]
            });

            // 2. Map Initialization
            const view = new ol.View({
                // Center on Continental US (approx. Lon: -98, Lat: 38)
                center: ol.proj.fromLonLat([-98, 38]),
                zoom: 4, // Appropriate zoom level
                minZoom: 2,
                maxZoom: 18
            });

            const map = new ol.Map({
                target: 'map',
                layers: [baseLayerGroup, wmsLayer], // Add both the group and the WMS layer
                view: view,
            });

            // 3. Basemap Switcher Logic
            const basemapSwitcher = document.getElementById('basemap-switcher');
            const baseMapInputs = basemapSwitcher.querySelectorAll('input[name="basemap"]');

            baseMapInputs.forEach(input => {
                input.addEventListener('change', (event) => {
                    const selectedTitle = event.target.value;

                    // Iterate over the layers in the basemap group
                    baseLayerGroup.getLayers().forEach(layer => {
                        // Check if the layer title matches the selected radio button value
                        if (layer.get('title') === selectedTitle) {
                            layer.setVisible(true);
                        } else {
                            layer.setVisible(false);
                        }
                    });
                });
            });

            // 4. WMS Layer Toggle Logic
            const wmsToggle = document.getElementById('wms-toggle');
            wmsToggle.addEventListener('change', (event) => {
                // Set the WMS layer visibility based on the checkbox state
                wmsLayer.setVisible(event.target.checked);
            });
        };
    </script>
</body>
</html>
